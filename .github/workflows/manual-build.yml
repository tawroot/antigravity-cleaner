name: ðŸ”§ Manual Build & Test

on:
  workflow_dispatch:
    inputs:
      platform:
        description: 'Platform to build'
        required: true
        type: choice
        options:
          - all
          - windows
          - macos
          - linux
      create_release:
        description: 'Create GitHub Release'
        required: false
        type: boolean
        default: false
      release_tag:
        description: 'Release tag (if creating release)'
        required: false
        default: 'v4.0.1-test'

permissions:
  contents: write

jobs:
  # Security: Only allow repository owner to run manual builds
  check-permission:
    name: ðŸ”’ Check Permission
    runs-on: ubuntu-latest
    steps:
      - name: Verify repository owner
        run: |
          if [ "${{ github.actor }}" != "${{ github.repository_owner }}" ]; then
            echo "âŒ Error: Only repository owner can run manual builds"
            echo "Actor: ${{ github.actor }}"
            echo "Owner: ${{ github.repository_owner }}"
            exit 1
          fi
          echo "âœ… Permission verified: ${{ github.actor }}"

  build-windows:
    needs: check-permission
    name: ðŸªŸ Build Windows
    runs-on: windows-latest
    if: ${{ github.event.inputs.platform == 'all' || github.event.inputs.platform == 'windows' }}
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ðŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: ðŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install customtkinter psutil pycryptodome rich pillow pyinstaller

      - name: ðŸ”¨ Build
        shell: pwsh
        run: |
          python -m PyInstaller `
            --onefile --windowed --name "AntigravityCleaner" `
            --clean --noupx `
            --version-file=version_info.txt --manifest=app.manifest --icon=icon.ico `
            --add-data "src;src" --add-data "LICENSE;." `
            --hidden-import=customtkinter --hidden-import=tkinter `
            --hidden-import=PIL --hidden-import=PIL._tkinter_finder `
            src/gui_apple.py

      - name: ðŸ“¦ Package
        shell: pwsh
        run: |
          $dir = "AntigravityCleaner-Portable"
          New-Item -ItemType Directory -Path $dir -Force | Out-Null
          Copy-Item "dist/AntigravityCleaner.exe" "$dir/"
          Copy-Item "README.md", "LICENSE" "$dir/"
          "Portable Build - Windows" | Out-File "$dir/PORTABLE.txt"
          New-Item -ItemType Directory -Path "$dir/data" -Force | Out-Null
          Compress-Archive -Path "$dir/*" -DestinationPath "AntigravityCleaner-Windows-Portable.zip"

      - name: ðŸ“¤ Upload
        uses: actions/upload-artifact@v4
        with:
          name: Windows-build
          path: AntigravityCleaner-Windows-Portable.zip

  build-macos:
    name: ðŸŽ Build macOS
    runs-on: macos-latest
    if: ${{ github.event.inputs.platform == 'all' || github.event.inputs.platform == 'macos' }}
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ðŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: ðŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install customtkinter psutil pycryptodome rich pillow pyinstaller

      - name: ðŸ”¨ Build
        run: |
          python -m PyInstaller \
            --onefile --windowed --name "AntigravityCleaner" \
            --clean --noupx --icon=icon.png \
            --add-data "src:src" --add-data "LICENSE:." \
            --hidden-import=customtkinter --hidden-import=tkinter \
            --hidden-import=PIL --hidden-import=PIL._tkinter_finder \
            src/gui_apple.py

      - name: ðŸ“¦ Package
        run: |
          dir="AntigravityCleaner-Portable"
          mkdir -p "$dir"
          cp "dist/AntigravityCleaner" "$dir/"
          chmod +x "$dir/AntigravityCleaner"
          cp README.md LICENSE "$dir/"
          echo "Portable Build - macOS" > "$dir/PORTABLE.txt"
          mkdir -p "$dir/data"
          cd "$dir" && zip -r "../AntigravityCleaner-macOS-Portable.zip" . && cd ..

      - name: ðŸ“¤ Upload
        uses: actions/upload-artifact@v4
        with:
          name: macOS-build
          path: AntigravityCleaner-macOS-Portable.zip

  build-linux:
    name: ðŸ§ Build Linux
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.platform == 'all' || github.event.inputs.platform == 'linux' }}
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ðŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: ðŸ“¦ Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y python3-tk python3-dev

      - name: ðŸ“¦ Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install customtkinter psutil pycryptodome rich pillow pyinstaller

      - name: ðŸ”¨ Build
        run: |
          python -m PyInstaller \
            --onefile --name "AntigravityCleaner" \
            --clean --noupx \
            --add-data "src:src" --add-data "LICENSE:." \
            --hidden-import=customtkinter --hidden-import=tkinter \
            --hidden-import=PIL --hidden-import=PIL._tkinter_finder \
            src/gui_apple.py

      - name: ðŸ“¦ Package
        run: |
          dir="AntigravityCleaner-Portable"
          mkdir -p "$dir"
          cp "dist/AntigravityCleaner" "$dir/"
          chmod +x "$dir/AntigravityCleaner"
          cp README.md LICENSE "$dir/"
          echo "Portable Build - Linux" > "$dir/PORTABLE.txt"
          mkdir -p "$dir/data"
          tar -czf "AntigravityCleaner-Linux-Portable.tar.gz" -C "$dir" .

      - name: ðŸ“¤ Upload
        uses: actions/upload-artifact@v4
        with:
          name: Linux-build
          path: AntigravityCleaner-Linux-Portable.tar.gz

  create-release:
    name: ðŸŽ‰ Create Release
    needs: [build-windows, build-macos, build-linux]
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.create_release == 'true' && !cancelled() }}
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ðŸ“¥ Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: release-assets
          merge-multiple: true

      - name: ðŸš€ Create Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="${{ github.event.inputs.release_tag }}"
          gh release delete "$TAG" --yes 2>/dev/null || true
          gh release create "$TAG" \
            --title "Antigravity Cleaner $TAG" \
            --notes "Manual build release" \
            release-assets/*
