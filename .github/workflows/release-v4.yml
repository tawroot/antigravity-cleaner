name: ðŸš€ Build & Release v4.0

on:
  push:
    tags:
      - 'v4.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., v4.0.1)'
        required: true
        default: 'v4.0.1'

permissions:
  contents: write

jobs:
  # Security: Only allow repository owner to create releases
  check-permission:
    name: ðŸ”’ Check Permission
    runs-on: ubuntu-latest
    steps:
      - name: Verify repository owner
        run: |
          ALLOWED_ACTORS=("tawroot" "tawanamohammadi")
          IS_ALLOWED=false
          for actor in "${ALLOWED_ACTORS[@]}"; do
            if [ "${{ github.actor }}" == "$actor" ]; then
              IS_ALLOWED=true
              break
            fi
          done
          
          if [ "$IS_ALLOWED" = false ]; then
            echo "âŒ Error: Unauthorized actor"
            echo "Actor: ${{ github.actor }}"
            exit 1
          fi
          echo "âœ… Permission verified: ${{ github.actor }}"

  build:
    needs: check-permission
    name: Build ${{ matrix.platform }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: windows-latest
            platform: Windows
            ext: .exe
            archive: zip
            artifact: AntigravityCleaner-v4.0-Windows-Portable.zip
          - os: macos-latest
            platform: macOS
            ext: ''
            archive: zip
            artifact: AntigravityCleaner-v4.0-macOS-Portable.zip
          - os: ubuntu-latest
            platform: Linux
            ext: ''
            archive: tar.gz
            artifact: AntigravityCleaner-v4.0-Linux-Portable.tar.gz

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: ðŸ“¦ Install system dependencies (Linux)
        if: matrix.platform == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y python3-tk python3-dev

      - name: ðŸ“¦ Install Python dependencies
        run: |
          python -m pip install --upgrade pip setuptools wheel
          pip install customtkinter psutil pycryptodome rich pillow pyinstaller

      - name: ðŸ”¨ Build executable (Windows)
        if: matrix.platform == 'Windows'
        shell: pwsh
        run: |
          # Execute the unified build script
          ./build_portable.ps1

      - name: ðŸ”¨ Build executable (macOS)
        if: matrix.platform == 'macOS'
        run: |
          echo "Building for macOS..."
          
          python -m PyInstaller \
            --onefile \
            --windowed \
            --name "AntigravityCleaner" \
            --clean \
            --noupx \
            --icon=icon.png \
            --add-data "src:src" \
            --add-data "LICENSE:." \
            --hidden-import=customtkinter \
            --hidden-import=tkinter \
            --hidden-import=tkinter.ttk \
            --hidden-import=tkinter.messagebox \
            --hidden-import=PIL \
            --hidden-import=PIL._tkinter_finder \
            src/gui_apple.py
          
          echo "Build completed!"

      - name: ðŸ”¨ Build executable (Linux)
        if: matrix.platform == 'Linux'
        run: |
          echo "Building for Linux..."
          
          python -m PyInstaller \
            --onefile \
            --name "AntigravityCleaner" \
            --clean \
            --noupx \
            --add-data "src:src" \
            --add-data "LICENSE:." \
            --hidden-import=customtkinter \
            --hidden-import=tkinter \
            --hidden-import=tkinter.ttk \
            --hidden-import=tkinter.messagebox \
            --hidden-import=PIL \
            --hidden-import=PIL._tkinter_finder \
            src/gui_apple.py
          
          echo "Build completed!"

      - name: ðŸ“¦ Create Portable Package (Windows)
        if: matrix.platform == 'Windows'
        shell: pwsh
        run: |
          Write-Host "Verifying portable package..." -ForegroundColor Cyan
          if (Test-Path "AntigravityCleaner-Windows-Portable.zip") {
              # Rename to match expected artifact name
              Move-Item "AntigravityCleaner-Windows-Portable.zip" "${{ matrix.artifact }}" -Force
              Write-Host "Package ready: ${{ matrix.artifact }}" -ForegroundColor Green
          } else {
              Write-Host "Error: ZIP file not found!" -ForegroundColor Red
              exit 1
          }

      - name: ðŸ“¦ Create Portable Package (macOS)
        if: matrix.platform == 'macOS'
        run: |
          echo "Creating portable package..."
          
          portableDir="AntigravityCleaner-Portable"
          mkdir -p "$portableDir"
          
          # Copy executable
          cp "dist/AntigravityCleaner" "$portableDir/"
          chmod +x "$portableDir/AntigravityCleaner"
          
          # Copy documentation
          cp "README.md" "$portableDir/"
          cp "LICENSE" "$portableDir/"
          
          # Create portable marker
          cat > "$portableDir/PORTABLE.txt" << 'EOF'
          Antigravity Cleaner - Portable Edition
          ======================================

          Version: 4.0.0
          Platform: macOS
          Build Date: $(date -u '+%Y-%m-%d %H:%M:%S UTC')

          Copyright Â© 2024-2025 Tawana Mohammadi / Tawana Network
          All Rights Reserved

          This is the portable version. No installation required.
          Just run ./AntigravityCleaner

          Features:
          - Premium Apple-Style UI
          - Multi-browser Session Management
          - Google Services Diagnostics
          - Network Optimization Tools
          - Encrypted Session Backups (AES-256-GCM)

          Support: https://github.com/tawroot/antigravity-cleaner/issues
          Website: https://tawroot.github.io/antigravity-cleaner/
          Telegram: https://t.me/panbehnet
          EOF
          
          # Create data folder
          mkdir -p "$portableDir/data"
          
          # Create ZIP archive
          cd "$portableDir" && zip -r "../${{ matrix.artifact }}" . && cd ..
          
          echo "Package created: ${{ matrix.artifact }}"

      - name: ðŸ“¦ Create Portable Package (Linux)
        if: matrix.platform == 'Linux'
        run: |
          echo "Creating portable package..."
          
          portableDir="AntigravityCleaner-Portable"
          mkdir -p "$portableDir"
          
          # Copy executable
          cp "dist/AntigravityCleaner" "$portableDir/"
          chmod +x "$portableDir/AntigravityCleaner"
          
          # Copy documentation
          cp "README.md" "$portableDir/"
          cp "LICENSE" "$portableDir/"
          
          # Create portable marker
          cat > "$portableDir/PORTABLE.txt" << 'EOF'
          Antigravity Cleaner - Portable Edition
          ======================================

          Version: 4.0.0
          Platform: Linux
          Build Date: $(date -u '+%Y-%m-%d %H:%M:%S UTC')

          Copyright Â© 2024-2025 Tawana Mohammadi / Tawana Network
          All Rights Reserved

          This is the portable version. No installation required.
          Just run ./AntigravityCleaner

          Features:
          - Premium Apple-Style UI
          - Multi-browser Session Management
          - Google Services Diagnostics
          - Network Optimization Tools
          - Encrypted Session Backups (AES-256-GCM)

          Support: https://github.com/tawroot/antigravity-cleaner/issues
          Website: https://tawroot.github.io/antigravity-cleaner/
          Telegram: https://t.me/panbehnet
          EOF
          
          # Create data folder
          mkdir -p "$portableDir/data"
          
          # Create TAR.GZ archive
          tar -czf "${{ matrix.artifact }}" -C "$portableDir" .
          
          echo "Package created: ${{ matrix.artifact }}"

      - name: ðŸ“¤ Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.platform }}-build
          path: ${{ matrix.artifact }}
          retention-days: 7
          compression-level: 0  # Already compressed

  release:
    name: ðŸŽ‰ Create GitHub Release
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ“¥ Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: release-assets
          merge-multiple: true

      - name: ðŸ“‹ Display structure
        run: |
          echo "Release assets:"
          ls -lh release-assets/

      - name: ðŸ·ï¸ Get version tag
        id: get_version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "version=${{ github.ref_name }}" >> $GITHUB_OUTPUT
          fi

      - name: ðŸš€ Create Release with GitHub CLI
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG_NAME="${{ steps.get_version.outputs.version }}"
          
          echo "Creating release for $TAG_NAME..."
          
          # Delete release if exists (for retry scenarios)
          gh release delete "$TAG_NAME" --yes 2>/dev/null || true
          
          # Create notes file to avoid YAML indentation issues
          cat > release_notes.md << 'EOF'
          ## ðŸ’Ž Official Portable Release - Multi-Platform

          ### âœ¨ What's New in v4.0.0

          #### ðŸŽ¨ **Premium User Interface**
          - **Apple-Style Design** with Glassmorphism effects and smooth animations
          - **Dark/Light Mode** support with beautiful transitions
          - **Responsive Layout** that adapts to any window size
          - **Bilingual Interface** - Full English & Persian (ÙØ§Ø±Ø³ÛŒ) support with RTL

          #### ðŸš€ **Core Features**
          - **ðŸ§¹ System Cleaning** - Deep clean Antigravity IDE traces, temp files, and caches
          - **ðŸ’¾ Session Manager** - Encrypted backup & restore for 8+ browsers
            - Chrome, Edge, Firefox, Brave, Opera, Vivaldi, Arc, Safari
            - AES-256-GCM encryption for maximum security
          - **ðŸŒ Google Connectivity Test** - Real-time diagnostics for:
            - Google Account access
            - Gemini AI services
            - Google Cloud Platform
            - AI Studio connectivity
          - **ðŸ”§ Network Optimizer** - DNS flush, network reset, and diagnostics

          #### ðŸ“¦ **Package Details**

          Each portable package contains:
          - âœ… `AntigravityCleaner` executable (platform-specific)
          - âœ… `README.md` - Complete documentation
          - âœ… `LICENSE` - License terms
          - âœ… `PORTABLE.txt` - Quick start guide
          - âœ… `data/` - Auto-created folder for settings and backups

          #### ðŸš€ **Quick Start**

          **Windows:**
          ```powershell
          # Extract ZIP and run
          .\AntigravityCleaner.exe
          ```

          **macOS:**
          ```bash
          # Extract ZIP and run
          chmod +x AntigravityCleaner
          ./AntigravityCleaner
          ```

          **Linux:**
          ```bash
          # Extract TAR.GZ and run
          tar -xzf AntigravityCleaner-v4.0-Linux-Portable.tar.gz
          chmod +x AntigravityCleaner
          ./AntigravityCleaner
          ```

          #### ðŸ›¡ï¸ **Security Notes**

          - âœ… **No Installation Required** - Fully portable, runs from any location
          - âœ… **Data Privacy** - All data stored locally in `data/` folder
          - âœ… **Encrypted Backups** - Session backups use AES-256-GCM encryption
          - âœ… **Open Source** - Full source code available for review
          - âš ï¸ **Windows SmartScreen** - First run may show warning (normal for unsigned apps)
            - Click "More info" â†’ "Run anyway"

          #### ðŸŒ **Multi-Language Support**

          Full documentation available in:
          - ðŸ‡ºðŸ‡¸ English - [README.md](https://github.com/tawroot/antigravity-cleaner/blob/main/README.md)
          - ðŸ‡®ðŸ‡· ÙØ§Ø±Ø³ÛŒ - [README.fa.md](https://github.com/tawroot/antigravity-cleaner/blob/main/README.fa.md)
          - ðŸ‡¨ðŸ‡³ ä¸­æ–‡ - [README.zh.md](https://github.com/tawroot/antigravity-cleaner/blob/main/README.zh.md)
          - ðŸ‡·ðŸ‡º Ð ÑƒÑÑÐºÐ¸Ð¹ - [README.ru.md](https://github.com/tawroot/antigravity-cleaner/blob/main/README.ru.md)
          - ðŸ‡¹ðŸ‡· TÃ¼rkÃ§e - [README.tr.md](https://github.com/tawroot/antigravity-cleaner/blob/main/README.tr.md)
          - ðŸ‡¸ðŸ‡¦ Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© - [README.ar.md](https://github.com/tawroot/antigravity-cleaner/blob/main/README.ar.md)
          - ðŸ‡ªðŸ‡¸ EspaÃ±ol - [README.es.md](https://github.com/tawroot/antigravity-cleaner/blob/main/README.es.md)

          #### ðŸ“Š **System Requirements**

          | Platform | Requirements |
          |----------|-------------|
          | **Windows** | Windows 10/11 (x64) |
          | **macOS** | macOS 10.15 Catalina or later |
          | **Linux** | Any modern distro with Python 3.10+ |

          #### ðŸ¤ **Support & Community**

          - ðŸ“¢ **Telegram Channel**: [t.me/panbehnet](https://t.me/panbehnet)
          - ðŸ› **Report Issues**: [GitHub Issues](https://github.com/tawroot/antigravity-cleaner/issues)
          - ðŸŒ **Website**: [tawroot.github.io/antigravity-cleaner](https://tawroot.github.io/antigravity-cleaner/)
          - ðŸ’¬ **Contact**: [@RAHBARUSD](https://t.me/RAHBARUSD)

          #### ðŸ™ **Credits**

          Developed with â¤ï¸ by **Tawana Network**

          **Copyright Â© 2024-2025 Tawana Mohammadi / Tawana Network**  
          All Rights Reserved.

          ---

          ### ðŸ“¥ Download the version for your platform below â¬‡ï¸
          EOF

          # Create new release using the notes file
          gh release create "$TAG_NAME" \
            --title "ðŸš€ Antigravity Cleaner Pro $TAG_NAME" \
            --notes-file release_notes.md \
            release-assets/*

          echo "âœ… Release created successfully!"

      - name: ðŸŽŠ Success notification
        run: |
          echo "================================================"
          echo "ðŸŽ‰ Release ${{ steps.get_version.outputs.version }} created successfully!"
          echo "================================================"
          echo ""
          echo "ðŸ“¦ Artifacts uploaded:"
          ls -lh release-assets/
          echo ""
          echo "ðŸ”— View release: https://github.com/${{ github.repository }}/releases/tag/${{ steps.get_version.outputs.version }}"
